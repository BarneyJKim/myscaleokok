<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKOK 체중계 식별 도구 (v1.8 - 자동 재시작)</title> 
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; }
        #identification-result { font-size: 2rem; font-weight: bold; margin: 15px 0; color: #DC3545; }
        #weight-display { font-size: 4rem; font-weight: bold; color: #34C759; margin: 20px 0; }
        #status { color: #666; margin-bottom: 20px; font-size: 0.9rem; }
        button { background-color: #007AFF; color: white; border: none; padding: 15px 30px; font-size: 1.2rem; border-radius: 30px; cursor: pointer; transition: background 0.2s; width: 100%; }
        #copyBtn { background-color: #FF9500; margin-top: 10px; }
        button:active { background-color: #0056b3; }
        #copyBtn:active { background-color: #e58700; }
        #log { text-align: left; background: #eee; padding: 10px; border-radius: 5px; margin-top: 20px; height: 150px; overflow-y: scroll; font-family: monospace; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="appTitle">체중계 식별 도구 (v1.8)</h1>
    <div id="status">버튼을 눌러 목록을 띄우고, **이름 없는 기기**를 하나씩 선택해 테스트하세요.</div>
    
    <div id="identification-result">❌ 식별 테스트 대기 중...</div>
    <div id="weight-display">-- kg</div>
    
    <button id="scanBtn">스캔 및 식별 테스트 시작</button>
    <button id="copyBtn" style="display: none;">클립보드에 체중 복사</button>

    <div id="log"></div>
</div>

<script>
    const scanBtn = document.getElementById('scanBtn');
    const copyBtn = document.getElementById('copyBtn');
    const statusDiv = document.getElementById('status');
    const resultDiv = document.getElementById('identification-result');
    const weightDisplay = document.getElementById('weight-display');
    const logDiv = document.getElementById('log');

    const TARGET_MANUFACTURER_ID = 0x0000; 
    const FIXED_MAC_SEQUENCE = [0x7C, 0x09, 0x61, 0x91, 0x78, 0xF3]; 
    let lastLogTime = 0;
    let currentDevice = null;

    function log(message) {
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${time}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // UI를 초기 상태로 리셋하는 함수
    function resetUI() {
        scanBtn.disabled = false;
        statusDiv.innerText = "버튼을 눌러 목록을 띄우고, 이름 없는 기기를 하나씩 선택해 테스트하세요.";
        resultDiv.innerText = "❌ 식별 테스트 대기 중...";
        resultDiv.style.color = "#DC3545";
        weightDisplay.innerText = "-- kg";
        copyBtn.style.display = 'none';
        
        // 이전 장치가 있다면 이벤트 리스너 제거
        if (currentDevice) {
            currentDevice.removeEventListener('advertisementreceived', handleAdvertisement);
            currentDevice = null;
        }
    }

    function isTargetScale(data) {
        const macLength = FIXED_MAC_SEQUENCE.length;
        if (data.length < macLength) {
            return false;
        }
        for (let i = 0; i < macLength; i++) {
            if (data[data.length - macLength + i] !== FIXED_MAC_SEQUENCE[i]) {
                return false;
            }
        }
        return true;
    }

    function parseWeight(data) {
        const macLength = FIXED_MAC_SEQUENCE.length;
        if (data.length < macLength + 2) return null;

        const highByteIndex = data.length - macLength - 2;
        const lowByteIndex = data.length - macLength - 1;

        const rawWeight = (data[highByteIndex] << 8) | data[lowByteIndex]; 
        let weight = rawWeight / 100;
        
        if (weight > 0.5 && weight < 300) {
            return weight;
        }
        return null;
    }
    
    function copyWeight() {
        const weight = weightDisplay.innerText.replace(' kg', '').trim();
        navigator.clipboard.writeText(weight).then(() => {
            alert(`✅ ${weight} kg이 클립보드에 복사되었습니다! 이제 건강 앱에 붙여넣으세요.`);
        }).catch(err => {
            console.error('클립보드 복사 실패:', err);
            alert('클립보드 복사 실패: 수동으로 복사해 주세요.');
        });
    }
    copyBtn.addEventListener('click', copyWeight);

    // --- 광고 수신 핸들러 (식별 로직) ---
    function handleAdvertisement(event) {
        const advertisement = event.advertisement;
        const currentTime = Date.now();
        
        if (advertisement.manufacturerData.has(TARGET_MANUFACTURER_ID)) {
            const dataBuffer = advertisement.manufacturerData.get(TARGET_MANUFACTURER_ID);
            const data = new Uint8Array(dataBuffer.buffer);

            // 1초에 한 번만 로그에 출력하여 데이터 변화 확인
            if (currentTime - lastLogTime > 1000) {
                 let hexString = '';
                 data.forEach(byte => {
                     hexString += byte.toString(16).padStart(2, '0').toUpperCase() + ' ';
                 });
                 log(`[신호 감지] RAW Data: ${hexString.trim()}`);
                 lastLogTime = currentTime;
            }

            // 2. 체중계 MAC 시퀀스 일치 여부 검사 (핵심 식별)
            if (isTargetScale(data)) {
                // --- 식별 성공 시 UI 업데이트 ---
                resultDiv.innerText = "✅ 식별 성공: 체중계입니다.";
                resultDiv.style.color = "#34C759"; // 녹색
                
                const weight = parseWeight(data);

                if (weight !== null) {
                    weightDisplay.innerText = `${weight.toFixed(2)} kg`; 
                    statusDiv.innerText = `✅ 체중 수신 완료 (MAC 확인됨)`;
                    copyBtn.style.display = 'block'; 
                }
            }
        }
    }
    
    // --- 스캔 및 식별 함수 ---
    async function scanBluetooth() {
        // 이미 스캔 중이면 중복 실행 방지
        if (scanBtn.disabled) return;
        
        resetUI(); // 이전 상태 초기화
        log("------------------------------------------");
        log("새로운 장치 식별 테스트를 시작합니다.");

        try {
            statusDiv.innerText = "① 장치 목록 로딩 중... 체중계에 올라서서 신호가 나오도록 하세요.";
            scanBtn.disabled = true;

            const options = {
                acceptAllDevices: true, 
                optionalManufacturerData: [TARGET_MANUFACTURER_ID] 
            };
            
            // 1. 장치 선택 요청
            currentDevice = await navigator.bluetooth.requestDevice(options);
            
            log(`장치 선택됨: ${currentDevice.name || '알 수 없음'} (${currentDevice.id})`);
            
            // 2. 선택 후 즉시 신호 감시 시작
            currentDevice.addEventListener('advertisementreceived', handleAdvertisement);
            
            // 연결 끊김 이벤트 처리 추가: 연결이 끊기면 다시 시도할 수 있도록 버튼 활성화
            currentDevice.addEventListener('advertisementsstopped', () => {
                log(`[감시 중단] ${currentDevice.name || '선택된 장치'}의 감시가 중단되었습니다.`);
                resetUI();
            });

            await currentDevice.watchAdvertisements();
            
            statusDiv.innerText = `② '${currentDevice.name || '선택된 장치'}'의 신호를 감시 중입니다. 체중계인지 확인 중...`;
            log("신호 감시 시작. RAW 데이터가 1초마다 출력됩니다.");

        } catch (error) {
            // 사용자가 목록에서 취소했을 경우 (NotFoundError)는 흔함
            if (error.name === 'NotFoundError') {
                log("사용자가 장치 선택을 취소했습니다. 다음 후보를 테스트하려면 버튼을 다시 누르세요.");
                statusDiv.innerText = "⚠️ 선택 취소. 다음 후보를 테스트하려면 버튼을 다시 누르세요.";
            } else {
                 log(`❌ 치명적 에러 발생: ${error.message}`);
                 statusDiv.innerText = `❌ 에러 발생: ${error.message}. 다시 시도하세요.`;
            }
            scanBtn.disabled = false; // 에러가 나도 버튼을 다시 활성화하여 재시도 유도
        }
    }

    scanBtn.addEventListener('click', scanBluetooth);
</script>

</body>
</html>
