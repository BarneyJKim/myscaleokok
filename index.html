<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKOK 체중계 스캐너</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; }
        #weight-display { font-size: 4rem; font-weight: bold; color: #34C759; margin: 20px 0; }
        #status { color: #666; margin-bottom: 20px; font-size: 0.9rem; }
        button { background-color: #34C759; color: white; border: none; padding: 15px 30px; font-size: 1.2rem; border-radius: 30px; cursor: pointer; transition: background 0.2s; width: 100%; }
        button:active { background-color: #28a745; }
        #log { text-align: left; background: #eee; padding: 10px; border-radius: 5px; margin-top: 20px; height: 150px; overflow-y: scroll; font-family: monospace; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>OKOK 체중계 브로드캐스트 스캐너</h1>
    <div id="status">연결 버튼을 눌러 주변 기기를 스캔하세요.</div>
    
    <div id="weight-display">-- kg</div>
    
    <button id="scanBtn">체중계 스캔 시작</button>

    <div id="log"></div>
</div>

<script>
    const scanBtn = document.getElementById('scanBtn');
    const statusDiv = document.getElementById('status');
    const weightDisplay = document.getElementById('weight-display');
    const logDiv = document.getElementById('log');

    // **사용자 지정 MAC 주소 (주의: Web Bluetooth API는 MAC 주소 필터링을 직접 지원하지 않음)**
    // Bluefy 브라우저는 MAC 주소로 장치를 식별할 수 있지만, 일반적인 Web Bluetooth API는
    // 보안상 이를 허용하지 않습니다. Bluefy에서 접속 시 MAC 주소 필터링을 시도하지만,
    // 작동하지 않으면 아래의 OKOK 특정 ID로 대체합니다.

    // OKOK 체중계의 일반적인 장치 이름 또는 브로드캐스트 데이터의 시작 부분 (MAC 대신)
    const TARGET_DEVICE_NAME = 'Body Fat Scale'; 
    
    // OKOK 체중계 (Chipsea)에서 자주 보이는 서비스 데이터 UUID (Vendor ID)
    const SERVICE_UUID_16 = 0xFFF0; // 16-bit UUID for Service Data

    function log(message) {
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${time}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // 바이트 배열(Uint8Array)에서 체중을 추출하는 함수
    function parseWeight(data) {
        // --- OKOK / Chipsea 브로드캐스트 데이터 해석 로직 ---
        
        // 1. 데이터가 체중 데이터 패킷인지 확인 (보통 0xCA로 시작하는 프로토콜)
        if (data[0] !== 0xCA) {
            // log("CA로 시작하지 않는 패킷 스킵.");
            return null; 
        }

        // 2. 무게 값 추출 (일반적으로 바이트 19와 20에 최종 무게 값이 저장됨)
        // 이 위치는 제조사/모델에 따라 달라질 수 있습니다.
        // 여기서는 가장 흔한 패턴인 **index 19 (High Byte)와 20 (Low Byte)**를 가정합니다.

        // (바이트 19 << 8) | 바이트 20 : 16비트 정수로 합치기
        // JavaScript DataView를 사용하여 Little Endian(LE)으로 읽을 수도 있습니다.
        const rawWeight = (data[19] << 8) | data[20];
        
        // rawWeight는 보통 실제 무게의 100배 또는 10배
        // 50.0 kg -> 5000 (100배) or 500 (10배)
        // OKOK 프로토콜은 보통 100배 (소수점 둘째 자리까지 포함)로 전송합니다.
        let weight = rawWeight / 100;
        
        // 3. 체중 값이 정상적인 범위인지 확인 (필터링)
        // 0kg이나 300kg 초과는 오류 또는 다른 데이터일 가능성 높음
        if (weight > 0 && weight < 300) {
            return weight;
        }

        return null;
    }

    async function scanBluetooth() {
        if (!navigator.bluetooth) {
            statusDiv.innerText = "Web Bluetooth를 지원하지 않는 브라우저입니다. Bluefy 앱을 사용하세요.";
            return;
        }

        try {
            statusDiv.innerText = "체중계 신호 검색 중... 체중계에 올라가세요.";
            log("스캔 요청 중...");
            scanBtn.disabled = true;

            // **주의:** Web Bluetooth 표준은 MAC 주소 필터링을 지원하지 않습니다.
            // 대신, OKOK 체중계가 브로드캐스트하는 Vendor ID/Service Data를 필터링합니다.
            const options = {
                // 이름 필터링 (선택 사항)
                // filters: [{ name: TARGET_DEVICE_NAME }], 
                
                // 브로드캐스트 데이터 전체 접근 권한 요청
                // Bluefy에서는 이 옵션을 사용하여 모든 브로드캐스트 데이터를 수신합니다.
                acceptAllDevices: true,
                optionalServices: [],
                // vendor-specific service data (OKOK 체중계는 0xFFF0을 자주 사용)
                optionalManufacturerData: [0x0000] 
            };
            
            // 1. 장치 검색 및 이벤트 리스너 등록
            const device = await navigator.bluetooth.requestDevice(options);
            log(`장치 선택됨: ${device.name} (${device.id})`);
            
            // 2. 장치 광고 데이터 이벤트 리스너 (브로드캐스트 데이터 수신)
            device.addEventListener('advertisementreceived', handleAdvertisement);

            // 3. 스캔 시작
            await device.watchAdvertisements();
            statusDiv.innerText = `스캔 중: ${device.name}. 체중계에 올라가세요.`;
            log("브로드캐스트 수신 시작.");

        } catch (error) {
            log(`에러 발생: ${error}`);
            statusDiv.innerText = "스캔 실패. 콘솔 로그를 확인하거나 Bluefy 앱 권한을 확인하세요.";
            scanBtn.disabled = false;
        }
    }

    function handleAdvertisement(event) {
        const advertisement = event.advertisement;
        
        // Bluefy에서는 `event.device.id`를 MAC 주소처럼 사용 가능하지만,
        // **안전하게 가기 위해** 브로드캐스트 데이터(Service Data) 내에서 체중을 찾습니다.

        // 1. Service Data 찾기 (OKOK 체중계가 데이터를 숨겨서 보내는 방식)
        if (advertisement.serviceData.has(SERVICE_UUID_16)) {
            const dataBuffer = advertisement.serviceData.get(SERVICE_UUID_16);
            const data = new Uint8Array(dataBuffer.buffer);

            let hexString = '';
            data.forEach(byte => {
                hexString += byte.toString(16).padStart(2, '0') + ' ';
            });
            // log(`RAW Data (${SERVICE_UUID_16.toString(16).toUpperCase()}): ${hexString}`);

            const weight = parseWeight(data);

            if (weight !== null) {
                // 체중계가 최종적으로 값을 고정했을 때
                weightDisplay.innerText = `${weight.toFixed(1)} kg`;
                statusDiv.innerText = `마지막 측정: ${new Date().toLocaleTimeString()}`;
            } else {
                // log("체중계 데이터가 아님 (CA 프로토콜 아님)");
            }
        }
    }

    scanBtn.addEventListener('click', scanBluetooth);
</script>

</body>
</html>
