<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKOK 체중계 스캐너 (파싱 완료)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; }
        #weight-display { font-size: 4rem; font-weight: bold; color: #34C759; margin: 20px 0; }
        #status { color: #666; margin-bottom: 20px; font-size: 0.9rem; }
        button { background-color: #34C759; color: white; border: none; padding: 15px 30px; font-size: 1.2rem; border-radius: 30px; cursor: pointer; transition: background 0.2s; width: 100%; }
        button:active { background-color: #28a745; }
        #log { text-align: left; background: #eee; padding: 10px; border-radius: 5px; margin-top: 20px; height: 150px; overflow-y: scroll; font-family: monospace; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>OKOK 체중계 스캐너 (No Ads)</h1>
    <div id="status">연결 버튼을 눌러 주변 기기를 스캔하세요.</div>
    
    <div id="weight-display">-- kg</div>
    
    <button id="scanBtn">체중계 스캔 시작</button>

    <div id="log"></div>
</div>

<script>
    const scanBtn = document.getElementById('scanBtn');
    const statusDiv = document.getElementById('status');
    const weightDisplay = document.getElementById('weight-display');
    const logDiv = document.getElementById('log');

    // MAC 주소는 필터링할 수 없으므로, 데이터 구조와 이름을 기반으로 찾습니다.
    const TARGET_MANUFACTURER_ID = 0x7B00; // Chipsea/OKOK의 일반적인 ID (0x0000으로 시도)

    function log(message) {
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${time}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    /**
     * OKOK/Chipsea 브로드캐스트 데이터에서 체중 값을 파싱합니다.
     * @param {Uint8Array} data - Manufacturer Data Array
     * @returns {number | null} - 해석된 체중 (kg) 또는 null
     */
    function parseWeight(data) {
        // 1. 헤더 확인 (FF C0...)
        // ManufacturerData의 경우, 0x0000 ID를 사용하면 data[0]이 C0, data[1]이 FF일 수 있습니다.
        // 여기서는 제공된 Payload의 핵심 바이트 위치(인덱스 4, 5)에 집중합니다.
        
        // 데이터의 길이가 충분한지 확인
        if (data.length < 6) return null;

        // 2. 무게 값 추출 (Index 4: Low Byte, Index 5: High Byte)
        // Little Endian (LE) 방식으로 디코딩합니다.
        // rawWeight = (High Byte * 256) + Low Byte
        const rawWeight = (data[5] << 8) | data[4];
        
        // 3. Status 플래그 확인 (선택적)
        // 인덱스 3이 0x08일 때 최종 측정값일 가능성이 높음 (측정 완료 상태)
        // const statusFlag = data[3]; 

        // 4. 단위 조정
        // OKOK는 보통 100배로 전송합니다 (50.78kg -> 5078)
        let weight = rawWeight / 100;
        
        // 5. 유효성 검사 (0kg 이거나 300kg 초과는 무시)
        if (weight > 0.5 && weight < 300) {
            return weight;
        }

        return null;
    }

    async function scanBluetooth() {
        if (!navigator.bluetooth) {
            statusDiv.innerText = "Web Bluetooth를 지원하지 않는 브라우저입니다. Bluefy 앱을 사용하세요.";
            return;
        }

        try {
            statusDiv.innerText = "체중계 신호 검색 중... 체중계에 올라가세요.";
            scanBtn.disabled = true;

            const options = {
                // 특정 MAC 주소 필터링은 보안상 불가능합니다.
                // 대신, 제조사 데이터 전체 접근 권한을 요청합니다.
                acceptAllDevices: true,
                optionalServices: [],
                // Chipsea/OKOK가 사용하는 Manufacturer Data 영역을 요청합니다.
                optionalManufacturerData: [0x0000] // ID 0x0000은 모든 Manufacturer Data를 포함할 때 사용됨
            };
            
            const device = await navigator.bluetooth.requestDevice(options);
            log(`장치 선택됨: ${device.name || '알 수 없음'} (${device.id})`);
            
            // 2. 장치 광고 데이터 이벤트 리스너 (브로드캐스트 데이터 수신)
            device.addEventListener('advertisementreceived', handleAdvertisement);

            // 3. 스캔 시작
            await device.watchAdvertisements();
            statusDiv.innerText = `스캔 중: ${device.name || '선택된 장치'}. 체중계에 올라가세요.`;

        } catch (error) {
            log(`에러 발생: ${error}`);
            statusDiv.innerText = "스캔 실패. Bluefy 앱 권한을 확인하세요.";
            scanBtn.disabled = false;
        }
    }

    function handleAdvertisement(event) {
        const advertisement = event.advertisement;
        
        // MAC 주소 필터링 (보안상 불가하므로, ID로 필터링)
        // 제공된 데이터는 ManufacturerData에 해당하므로, 0x0000을 통해 접근합니다.
        if (advertisement.manufacturerData.size > 0) {
            
            // 모든 ManufacturerData를 반복하며 확인
            for (const [manufacturerId, dataBuffer] of advertisement.manufacturerData.entries()) {
                
                const data = new Uint8Array(dataBuffer.buffer);

                // **제공된 데이터의 시작 패턴 확인: FF C0**
                // data[0]은 실제 ManufacturerID가 아니라 payload의 시작 바이트일 수 있음.
                // 따라서 패턴(FF, C0)이 보이는지 확인합니다.
                // 실제 ManufacturerID는 0x7B00 (Chipsea)이지만, 여기서는 데이터 자체를 확인합니다.
                
                // 디버깅을 위해 Raw Data를 로그에 남깁니다.
                let hexString = '';
                data.forEach(byte => {
                    hexString += byte.toString(16).padStart(2, '0').toUpperCase() + ' ';
                });
                // log(`[ID: ${manufacturerId.toString(16).toUpperCase()}] RAW Data: ${hexString}`);


                // **핵심 식별 및 파싱 로직**
                // 제공된 이미지에서는 FF C0으로 시작하는 데이터만 의미가 있습니다.
                // data[0]가 FF이고 data[1]이 C0인 패킷만 파싱을 시도합니다.
                if (data[0] === 0xFF && data[1] === 0xC0) {
                    const weight = parseWeight(data);

                    if (weight !== null) {
                        weightDisplay.innerText = `${weight.toFixed(1)} kg`;
                        statusDiv.innerText = `측정 완료 (마지막 측정: ${new Date().toLocaleTimeString()})`;
                    }
                }
            }
        }
    }

    scanBtn.addEventListener('click', scanBluetooth);
</script>

</body>
</html>