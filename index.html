<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKOK 체중계 스캐너 (ID 최적화)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; }
        #weight-display { font-size: 4rem; font-weight: bold; color: #34C759; margin: 20px 0; }
        #status { color: #666; margin-bottom: 20px; font-size: 0.9rem; }
        button { background-color: #34C759; color: white; border: none; padding: 15px 30px; font-size: 1.2rem; border-radius: 30px; cursor: pointer; transition: background 0.2s; width: 100%; }
        #copyBtn { background-color: #FF9500; margin-top: 10px; }
        button:active { background-color: #28a745; }
        #copyBtn:active { background-color: #e58700; }
        #log { text-align: left; background: #eee; padding: 10px; border-radius: 5px; margin-top: 20px; height: 150px; overflow-y: scroll; font-family: monospace; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>OKOK 체중계 스캐너 (ID 최적화)</h1>
    <div id="status">스캔 시작 후 체중계에 올라서세요.</div>
    
    <div id="weight-display">-- kg</div>
    
    <button id="scanBtn">체중계 스캔 시작</button>
    <button id="copyBtn" style="display: none;">클립보드에 체중 복사</button>

    <div id="log"></div>
</div>

<script>
    const scanBtn = document.getElementById('scanBtn');
    const copyBtn = document.getElementById('copyBtn');
    const statusDiv = document.getElementById('status');
    const weightDisplay = document.getElementById('weight-display');
    const logDiv = document.getElementById('log');

    // **Chipsea/OKOK 체중계의 표준 Manufacturer ID (0x7B00)를 사용합니다.**
    // 만약 0x7B00에서 잡히지 않으면, 0x0000(모든 데이터)를 사용해야 합니다.
    const TARGET_MANUFACTURER_ID = 0x7B00; 

    function log(message) {
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${time}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    /**
     * OKOK/Chipsea 브로드캐스트 데이터에서 체중 값을 파싱합니다.
     * 데이터 배열의 0, 1번 인덱스는 nRF Connect의 <ID> 값이었고,
     * 실제 체중은 2, 3번 인덱스에 Big Endian 방식으로 위치합니다.
     * @param {Uint8Array} data - Manufacturer Data Array
     */
    function parseWeight(data) {
        // nRF Connect <ID> 값(2바이트) 뒤에 체중 데이터가 시작한다고 가정
        if (data.length < 4) return null;

        // **새로운 파싱 로직: Index 2 (High Byte)와 Index 3 (Low Byte)를 체중으로 사용**
        // 예시: 25C0 | 1BF1 1388... -> 1BF1이 체중이었으므로, 이제 인덱스가 2와 3으로 밀림.
        // nRF Connect에서 <ID> 값(2바이트) 뒤에 체중(2바이트)이 옵니다. 
        
        // nRF Connect가 표시한 4바이트 중
        // data[0], data[1] = 25C0, 27C0, 28C0, 29C0 중 하나
        // data[2], data[3] = 체중 값 (1B F1, 1A 40 등)
        
        const rawWeight = (data[2] << 8) | data[3]; // Big Endian
        let weight = rawWeight / 100;
        
        if (weight > 0.5 && weight < 300) {
            return weight;
        }

        return null;
    }
    
    // --- 클립보드 복사 함수 (동일) ---
    function copyWeight() {
        const weight = weightDisplay.innerText.replace(' kg', '').trim();
        navigator.clipboard.writeText(weight).then(() => {
            alert(`✅ ${weight} kg이 클립보드에 복사되었습니다! 이제 건강 앱에 붙여넣으세요.`);
        }).catch(err => {
            console.error('클립보드 복사 실패:', err);
            alert('클립보드 복사 실패: 수동으로 복사해 주세요.');
        });
    }
    copyBtn.addEventListener('click', copyWeight);


    async function scanBluetooth() {
        if (!navigator.bluetooth) {
            statusDiv.innerText = "Web Bluetooth를 지원하지 않는 브라우저입니다. Bluefy 앱을 사용하세요.";
            return;
        }

        try {
            statusDiv.innerText = "체중계 신호 검색 중... 체중계에 올라가세요.";
            scanBtn.disabled = true;

            const options = {
                // 표준 Chipsea ID (0x7B00)를 필터로 사용
                filters: [{ manufacturerData: [{ companyIdentifier: TARGET_MANUFACTURER_ID }] }],
                optionalManufacturerData: [TARGET_MANUFACTURER_ID] 
            };
            
            const device = await navigator.bluetooth.requestDevice(options);
            log(`장치 선택됨: ${device.name || '알 수 없음'} (${device.id})`);
            
            device.addEventListener('advertisementreceived', handleAdvertisement);
            await device.watchAdvertisements();
            statusDiv.innerText = `스캔 중: ${device.name || '선택된 장치'}. 체중계에 올라서세요.`;

        } catch (error) {
            log(`에러 발생: ${error}`);
            statusDiv.innerText = "스캔 실패. 체중계 활성화(올라서기)를 확인하세요. ID를 0x0000으로 변경 시도 가능.";
            scanBtn.disabled = false;
        }
    }

    function handleAdvertisement(event) {
        const advertisement = event.advertisement;
        
        // 1. 표준 ID(0x7B00)의 데이터가 있는지 확인
        if (advertisement.manufacturerData.has(TARGET_MANUFACTURER_ID)) {
            
            const dataBuffer = advertisement.manufacturerData.get(TARGET_MANUFACTURER_ID);
            const data = new Uint8Array(dataBuffer.buffer);

            // 디버깅을 위해 Raw Data를 로그에 남깁니다.
            let hexString = '';
            data.forEach(byte => {
                hexString += byte.toString(16).padStart(2, '0').toUpperCase() + ' ';
            });
            log(`[ID: ${TARGET_MANUFACTURER_ID.toString(16).toUpperCase()}] RAW Data: ${hexString}`);

            const weight = parseWeight(data);

            if (weight !== null) {
                weightDisplay.innerText = `${weight.toFixed(2)} kg`; 
                statusDiv.innerText = `측정 완료 (마지막 측정: ${new Date().toLocaleTimeString()})`;
                copyBtn.style.display = 'block'; 
            }
        }
    }

    scanBtn.addEventListener('click', scanBluetooth);
</script>

</body>
</html>